"use strict";(()=>{var e={};e.id=40,e.ids=[40],e.modules={1185:e=>{e.exports=require("mongoose")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6271:(e,t,s)=>{s.r(t),s.d(t,{originalPathname:()=>g,patchFetch:()=>f,requestAsyncStorage:()=>c,routeModule:()=>u,serverHooks:()=>h,staticGenerationAsyncStorage:()=>m});var a={};s.r(a),s.d(a,{GET:()=>p});var n=s(9303),r=s(8716),i=s(3131),o=s(7070),l=s(4184),d=s(5033);async function p(e){try{await (0,l.v)();let{searchParams:t}=new URL(e.url),s=parseInt(t.get("page")||"1"),a=t.get("status"),n=parseInt(t.get("limit")||"10"),r=(s-1)*n,i={};a&&"all"!==a&&(i.status=a);let p=await d.Z.find(i).sort({createdAt:-1}).lean(),u={};p.forEach(e=>{let t=e.email;u[t]||(u[t]=[]),u[t].push({...e,id:e._id.toString()})});let c=Object.entries(u).map(([e,t])=>{let s=t[0],a=t.length,n=t.filter(e=>"pending"===e.status).length,r=t.filter(e=>"replied"===e.status).length,i="pending";return r===a?i="replied":0===n&&r<a&&(i="read"),{email:e,name:s.name,phone:s.phone,company:s.company,totalMessages:a,unreadCount:n,repliedCount:r,overallStatus:i,latestMessage:{subject:s.subject,message:s.message,createdAt:s.createdAt,status:s.status},lastReplySent:s.sent_on,firstContact:t[t.length-1].createdAt,contacts:t}});c.sort((e,t)=>new Date(t.latestMessage.createdAt).getTime()-new Date(e.latestMessage.createdAt).getTime());let m=c.length,h=c.slice(r,r+n);return o.NextResponse.json({success:!0,contacts:h,total:m,page:s,limit:n,totalPages:Math.ceil(m/n)})}catch(e){return o.NextResponse.json({success:!1,message:"Failed to fetch batched contacts"},{status:500})}}let u=new n.AppRouteRouteModule({definition:{kind:r.x.APP_ROUTE,page:"/api/contact/batched/route",pathname:"/api/contact/batched",filename:"route",bundlePath:"app/api/contact/batched/route"},resolvedPagePath:"/workspaces/dilipsingh076.github.io/src/app/api/contact/batched/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:c,staticGenerationAsyncStorage:m,serverHooks:h}=u,g="/api/contact/batched/route";function f(){return(0,i.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:m})}},5033:(e,t,s)=>{s.d(t,{Z:()=>o});var a=s(1185),n=s.n(a);let r=new a.Schema({subject:{type:String,required:!0,trim:!0},message:{type:String,required:!0},status:{type:String,enum:["pending","read","replied"],default:"pending"},sent_on:{type:Date},isAdminReply:{type:Boolean,default:!1},adminReplyTo:{type:String}},{timestamps:!0}),i=new a.Schema({name:{type:String,required:!0,trim:!0},email:{type:String,required:!0,trim:!0,unique:!0},phone:{type:String,trim:!0},company:{type:String,trim:!0},messages:[r],overallStatus:{type:String,enum:["pending","read","replied"],default:"pending"},lastMessageAt:{type:Date,required:!0},firstContactAt:{type:Date,required:!0}},{timestamps:!0});i.index({email:1}),i.index({overallStatus:1}),i.index({lastMessageAt:-1}),i.index({firstContactAt:-1}),i.methods.addMessage=function(e,t,s,a){return s&&(this.phone=s),a&&(this.company=a),this.messages.push({subject:e,message:t,status:"pending",createdAt:new Date}),this.lastMessageAt=new Date,this.firstContactAt||(this.firstContactAt=new Date),this.updateOverallStatus(),this.save()},i.methods.updateOverallStatus=function(){let e=this.messages.filter(e=>"pending"===e.status).length;this.messages.filter(e=>"replied"===e.status).length===this.messages.length?this.overallStatus="replied":0===e?this.overallStatus="read":this.overallStatus="pending"},i.methods.addAdminReply=function(e,t,s){return this.messages.push({subject:e,message:t,status:"replied",sent_on:new Date,isAdminReply:!0,adminReplyTo:s,createdAt:new Date}),this.lastMessageAt=new Date,this.updateOverallStatus(),this.save()},i.methods.markAllAsRead=function(){return this.messages.forEach(e=>{"pending"===e.status&&(e.status="read")}),this.updateOverallStatus(),this.save()},i.methods.markAllAsReplied=function(){return this.messages.forEach(e=>{"replied"!==e.status&&(e.status="replied",e.sent_on=new Date)}),this.updateOverallStatus(),this.save()};let o=n().models.Contact||n().model("Contact",i)},4184:(e,t,s)=>{s.d(t,{v:()=>l});var a=s(1185),n=s.n(a);let r=process.env.MONGODB_URI,i=process.env.MONGODB_DB_NAME||"portfolio";if(!r)throw Error("Please define the MONGODB_URI environment variable inside .env.local");let o=global.mongoose||{conn:null,promise:null};async function l(){if(o.conn)return o.conn;o.promise||(o.promise=n().connect(r,{bufferCommands:!1,dbName:i}).then(e=>e));try{o.conn=await o.promise}catch(e){throw o.promise=null,e}return o.conn}global.mongoose||(global.mongoose=o)}};var t=require("../../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),a=t.X(0,[276,972],()=>s(6271));module.exports=a})();